// Word cloud layout by Jason Davies, http://www.jasondavies.com/word-cloud/
// Algorithm due to Jonathan Feinberg, http://static.mrfeinberg.com/bv_ch03.pdf
function tsv(e){var t={},n,r;t.key=function(e){if(!arguments.length)return n;n=e;return t};t.value=function(e){if(!arguments.length)return r;r=e;return t};t.map=function(t){var i={},s=new XMLHttpRequest;s.overrideMimeType("text/plain");s.open("GET",e,!1);s.send(null);var o=s.responseText.split(/\n/g);for(var u=0;u<o.length;u++){var a=o[u].split(/\t/g),f=n(a);f!=null&&(i[f]=r(a))}return i};return t}function buildMap(e,t){function a(){console.log("show tooltip",d3.mouse(this));d3.select(".tooltip").style("left",d3.mouse(this)[0]).style("top",d3.mouse(this)[1])}function f(){console.log("hide tooltip")}var n=$("#map").outerWidth(),r=n<570?n:570,i=d3.geo.mercator().scale(1e3).translate([n/2,r/2]),s=d3.geo.path().projection(i),o=d3.select("#map").append("svg").attr("height",r).attr("viewBox","0 0 "+n+" "+r).attr("preserveAspectRatio","xMidYMid meet");o.append("rect").attr("width",n).attr("height",r);var u=o.append("g");d3.json("test3.json",function(o,l){var c=topojson.object(l,l.objects.subunits3).geometries;u.selectAll(".feature").data(c).enter().append("path").attr("d",s).attr("class",function(t){return e.indexOf(t.id)>-1?"feature glow "+t.id:"feature "+t.id});u.append("path").datum(topojson.mesh(l,l.objects.subunits3,function(e,t){return e!==t})).attr("class","mesh").attr("d",s);var h=e,p=[],d=[];u.selectAll("path").each(function(e){if(h.indexOf(e.id)>-1)if(e.id==="USA"){var t=i([-127.63,49.79]),n=i([-65.41,24.23]);p.push(t[0]);p.push(n[0]);d.push(t[1]);d.push(n[1])}else if(e.id==="CAN"){var t=i([-142,61]),n=i([-51,41]);p.push(t[0]);p.push(n[0]);d.push(t[1]);d.push(n[1])}else{p.push(s.bounds(e)[0][0]);p.push(s.bounds(e)[1][0]);d.push(s.bounds(e)[0][1]);d.push(s.bounds(e)[1][1])}});console.log(p,d);var v=i([-169,0]),m=i([180,0]),y=d3.min(p)>v[0]?d3.min(p):v[0],b=d3.max(p)<m[0]?d3.max(p):m[0],w=i([0,66]),E=i([0,-34]),S=d3.min(d)>w[1]?d3.min(d):w[1],x=d3.max(d)<E[1]?d3.max(d):E[1],T=[[y,S],[b,x]],N=.8/Math.max((T[1][0]-T[0][0])/n,(T[1][1]-T[0][1])/r);u.attr("transform","translate("+i.translate()+")"+"scale("+N+")"+"translate("+ -(T[1][0]+T[0][0])/2+","+ -(T[1][1]+T[0][1])/2+")");var C=u.selectAll(".country-label").data(c).enter().append("text").attr("class","country-label").text(function(e){return e.properties.name}).attr("transform",function(e){return"translate("+s.centroid(e)+") scale("+1/N+") translate("+this.getBBox().width/2*-1+",0)"});C.filter(function(t){return e.indexOf(t.id)<0}).attr("visibility","hidden");d3.json("other-regions.json",function(e,n){var r=topojson.object(n,n.objects["other-regions"]).geometries;console.log(r);u.selectAll(".region").data(r).enter().append("path").attr("d",s).on("click",function(e){window.location=e.id+".html"}).attr("class",function(e){return t.indexOf(e.id)>-1?"region glow "+e.id:"region "+e.id}).on("mouseover",a).on("mouseout",f);var i=u.selectAll(".region-label").data(r).enter().append("text").attr("class","region-label").text(function(e){return e.properties.name}).attr("transform",function(e){return"translate("+s.centroid(e)+") scale("+1/N+") translate("+this.getBBox().width/2*-1+",0)"});i.filter(function(e){return t.indexOf(e.id)<0}).attr("visibility","hidden")});var k=u.append("div").attr("class","tooltip")})}function report(){for(var e in originAggregate)used.indexOf(e)===-1&&console.log("MISMATCH: ",e)}(function(e){function t(){function k(t,n,r){var i=[{x:0,y:0},{x:e[0],y:e[1]}],s=n.x,o=n.y,u=Math.sqrt(e[0]*e[0]+e[1]*e[1]),a=w(e),l=Math.random()<.5?1:-1,h=-l,p,d,v;while(p=a(h+=l)){d=~~p[0];v=~~p[1];if(Math.min(d,v)>u)break;n.x=s+d;n.y=o+v;if(n.x+n.x0<0||n.y+n.y0<0||n.x+n.x1>e[0]||n.y+n.y1>e[1])continue;if(!r||!f(n,t,e[0]))if(!r||c(n,r)){var m=n.sprite,g=n.width>>5,y=e[0]>>5,b=n.x-(g<<4),E=b&127,S=32-E,x=n.y1-n.y0,T=(n.y+n.y0)*y+(b>>5),N;for(var C=0;C<x;C++){N=0;for(var k=0;k<=g;k++)t[T+k]|=N<<S|(k<g?(N=m[C*g+k])>>>E:0);T+=y}delete n.sprite;return!0}}return!1}var e=[256,256],t=n,p=r,v=s,m=i,g=i,y=o,b=u,w=h,E=[],x=Infinity,T=d3.dispatch("word","end"),N=null,C={};C.start=function(){function c(){var t=+(new Date),u;while(+(new Date)-t<x&&++s<i&&N){u=f[s];u.x=e[0]*(Math.random()+.5)>>1;u.y=e[1]*(Math.random()+.5)>>1;a(u,f,s);if(k(n,u,r)){o.push(u);T.word(u);r?l(r,u):r=[{x:u.x+u.x0,y:u.y+u.y0},{x:u.x+u.x1,y:u.y+u.y1}];u.x-=e[0]>>1;u.y-=e[1]>>1}}if(s>=i){C.stop();T.end(o,r)}}var n=d((e[0]>>5)*e[1]),r=null,i=E.length,s=-1,o=[],f=E.map(function(e,n){e.text=t.call(this,e,n);e.font=p.call(this,e,n);e.style=m.call(this,e,n);e.weight=g.call(this,e,n);e.rotate=y.call(this,e,n);e.size=~~v.call(this,e,n);e.padding=u.call(this,e,n);return e}).sort(function(e,t){return t.size-e.size});N&&clearInterval(N);N=setInterval(c,0);c();return C};C.stop=function(){if(N){clearInterval(N);N=null}return C};C.timeInterval=function(e){if(!arguments.length)return x;x=e==null?Infinity:e;return C};C.words=function(e){if(!arguments.length)return E;E=e;return C};C.size=function(t){if(!arguments.length)return e;e=[+t[0],+t[1]];return C};C.font=function(e){if(!arguments.length)return p;p=d3.functor(e);return C};C.fontStyle=function(e){if(!arguments.length)return m;m=d3.functor(e);return C};C.fontWeight=function(e){if(!arguments.length)return g;g=d3.functor(e);return C};C.rotate=function(e){if(!arguments.length)return y;y=d3.functor(e);return C};C.text=function(e){if(!arguments.length)return t;t=d3.functor(e);return C};C.spiral=function(e){if(!arguments.length)return w;w=S[e+""]||e;return C};C.fontSize=function(e){if(!arguments.length)return v;v=d3.functor(e);return C};C.padding=function(e){if(!arguments.length)return b;b=d3.functor(e);return C};return d3.rebind(C,T,"on")}function n(e){return e.text}function r(){return"serif"}function i(){return"normal"}function s(e){return Math.sqrt(e.value)}function o(){return(~~(Math.random()*6)-3)*30}function u(){return 1}function a(e,t,n){if(e.sprite)return;E.clearRect(0,0,(m<<5)/b,g/b);var r=0,i=0,s=0,o=t.length;n--;while(++n<o){e=t[n];E.save();E.font=e.style+" "+e.weight+" "+~~((e.size+1)/b)+"px "+e.font;var u=E.measureText(e.text+"m").width*b,a=e.size<<1;if(e.rotate){var f=Math.sin(e.rotate*v),l=Math.cos(e.rotate*v),c=u*l,h=u*f,p=a*l,d=a*f;u=Math.max(Math.abs(c+d),Math.abs(c-d))+31>>5<<5;a=~~Math.max(Math.abs(h+p),Math.abs(h-p))}else u=u+31>>5<<5;a>s&&(s=a);if(r+u>=m<<5){r=0;i+=s;s=0}if(i+a>=g)break;E.translate((r+(u>>1))/b,(i+(a>>1))/b);e.rotate&&E.rotate(e.rotate*v);E.fillText(e.text,0,0);E.restore();e.width=u;e.height=a;e.xoff=r;e.yoff=i;e.x1=u>>1;e.y1=a>>1;e.x0=-e.x1;e.y0=-e.y1;r+=u}var y=E.getImageData(0,0,(m<<5)/b,g/b).data,w=[];while(--n>=0){e=t[n];var u=e.width,S=u>>5,a=e.y1-e.y0,x=e.padding;for(var T=0;T<a*S;T++)w[T]=0;r=e.xoff;if(r==null)return;i=e.yoff;var N=0,C=-1;for(var k=0;k<a;k++){for(var T=0;T<u;T++){var L=S*k+(T>>5),A=y[(i+k)*(m<<5)+(r+T)<<2]?1<<31-T%32:0;if(x){k&&(w[L-S]|=A);k<u-1&&(w[L+S]|=A);A|=A<<1|A>>1}w[L]|=A;N|=A}if(N)C=k;else{e.y0++;a--;k--;i++}}e.y1=e.y0+C;e.sprite=w.slice(0,(e.y1-e.y0)*S)}}function f(e,t,n){n>>=5;var r=e.sprite,i=e.width>>5,s=e.x-(i<<4),o=s&127,u=32-o,a=e.y1-e.y0,f=(e.y+e.y0)*n+(s>>5),l;for(var c=0;c<a;c++){l=0;for(var h=0;h<=i;h++)if((l<<u|(h<i?(l=r[c*i+h])>>>o:0))&t[f+h])return!0;f+=n}return!1}function l(e,t){var n=e[0],r=e[1];t.x+t.x0<n.x&&(n.x=t.x+t.x0);t.y+t.y0<n.y&&(n.y=t.y+t.y0);t.x+t.x1>r.x&&(r.x=t.x+t.x1);t.y+t.y1>r.y&&(r.y=t.y+t.y1)}function c(e,t){return e.x+e.x1>t[0].x&&e.x+e.x0<t[1].x&&e.y+e.y1>t[0].y&&e.y+e.y0<t[1].y}function h(e){var t=e[0]/e[1];return function(e){return[t*(e*=.1)*Math.cos(e),e*Math.sin(e)]}}function p(e){var t=4,n=t*e[0]/e[1],r=0,i=0;return function(e){var s=e<0?-1:1;switch(Math.sqrt(1+4*s*e)-s&3){case 0:r+=n;break;case 1:i+=t;break;case 2:r-=n;break;default:i-=t}return[r,i]}}function d(e){var t=[],n=-1;while(++n<e)t[n]=0;return t}var v=Math.PI/180,m=64,g=2048,y,b=1;if(typeof document!="undefined"){y=document.createElement("canvas");y.width=1;y.height=1;b=Math.sqrt(y.getContext("2d").getImageData(0,0,1,1).data.length>>2);y.width=(m<<5)/b;y.height=g/b}else{var w=require("canvas");y=new w(m<<5,g)}var E=y.getContext("2d"),S={archimedean:h,rectangular:p};E.fillStyle="red";E.textAlign="center";e.cloud=t})(typeof exports=="undefined"?d3.layout||(d3.layout={}):exports);topojson=function(){function e(e,t){function s(t){var n=e.arcs[t],r=n[0],i=[0,0];n.forEach(function(e){i[0]+=e[0],i[1]+=e[1]});return[r,i]}var n={},r={},i={};t.forEach(function(e){var t=s(e);(n[t[0]]||(n[t[0]]=[])).push(e);(n[t[1]]||(n[t[1]]=[])).push(~e)});t.forEach(function(e){var t=s(e),n=t[0],o=t[1],u,a;if(u=i[n]){delete i[u.end];u.push(e);u.end=o;if(a=r[o]){delete r[a.start];var f=a===u?u:u.concat(a);r[f.start=u.start]=i[f.end=a.end]=f}else if(a=i[o]){delete r[a.start];delete i[a.end];var f=u.concat(a.map(function(e){return~e}).reverse());r[f.start=u.start]=i[f.end=a.start]=f}else r[u.start]=i[u.end]=u}else if(u=r[o]){delete r[u.start];u.unshift(e);u.start=n;if(a=i[n]){delete i[a.end];var l=a===u?u:a.concat(u);r[l.start=a.start]=i[l.end=u.end]=l}else if(a=r[n]){delete r[a.start];delete i[a.end];var l=a.map(function(e){return~e}).reverse().concat(u);r[l.start=a.end]=i[l.end=u.end]=l}else r[u.start]=i[u.end]=u}else if(u=r[n]){delete r[u.start];u.unshift(~e);u.start=o;if(a=i[o]){delete i[a.end];var l=a===u?u:a.concat(u);r[l.start=a.start]=i[l.end=u.end]=l}else if(a=r[o]){delete r[a.start];delete i[a.end];var l=a.map(function(e){return~e}).reverse().concat(u);r[l.start=a.end]=i[l.end=u.end]=l}else r[u.start]=i[u.end]=u}else if(u=i[o]){delete i[u.end];u.push(~e);u.end=n;if(a=i[n]){delete r[a.start];var f=a===u?u:u.concat(a);r[f.start=u.start]=i[f.end=a.end]=f}else if(a=r[n]){delete r[a.start];delete i[a.end];var f=u.concat(a.map(function(e){return~e}).reverse());r[f.start=u.start]=i[f.end=a.start]=f}else r[u.start]=i[u.end]=u}else{u=[e];r[u.start=n]=i[u.end=o]=u}});var o=[];for(var u in i)o.push(i[u]);return o}function t(t,r,i){var s=[];if(arguments.length>1){var o=[],u;function a(e){e<0&&(e=~e);(o[e]||(o[e]=[])).push(u)}function f(e){e.forEach(a)}function l(e){e.forEach(f)}function c(e){if(e.type==="GeometryCollection")e.geometries.forEach(c);else if(e.type in h){u=e;h[e.type](e.arcs)}}var h={LineString:f,MultiLineString:l,Polygon:l,MultiPolygon:function(e){e.forEach(l)}};c(r);o.forEach(arguments.length<3?function(e,t){s.push([t])}:function(e,t){i(e[0],e[e.length-1])&&s.push([t])})}else for(var p=0,d=t.arcs.length;p<d;++p)s.push([p]);return n(t,{type:"MultiLineString",arcs:e(t,s)})}function n(e,t){function f(e,t){t.length&&t.pop();for(var n=a[e<0?~e:e],f=0,l=n.length,c=0,h=0,p;f<l;++f)t.push([(c+=(p=n[f])[0])*i+o,(h+=p[1])*s+u]);e<0&&r(t,l)}function l(e){return[e[0]*i+o,e[1]*s+u]}function c(e){var t=[];for(var n=0,r=e.length;n<r;++n)f(e[n],t);t.length<2&&t.push(t[0]);return t}function h(e){var t=c(e);while(t.length<4)t.push(t[0]);return t}function p(e){return e.map(h)}function d(e){var t=e.type,n=t==="GeometryCollection"?{type:t,geometries:e.geometries.map(d)}:t in v?{type:t,coordinates:v[t](e)}:{type:null};"id"in e&&(n.id=e.id);"properties"in e&&(n.properties=e.properties);return n}var n=e.transform,i=n.scale[0],s=n.scale[1],o=n.translate[0],u=n.translate[1],a=e.arcs,v={Point:function(e){return l(e.coordinates)},MultiPoint:function(e){return e.coordinates.map(l)},LineString:function(e){return c(e.arcs)},MultiLineString:function(e){return e.arcs.map(c)},Polygon:function(e){return p(e.arcs)},MultiPolygon:function(e){return e.arcs.map(p)}};return d(t)}function r(e,t){var n,r=e.length,i=r-t;while(i<--r)n=e[i],e[i++]=e[r],e[r]=n}function i(e,t){var n=0,r=e.length;while(n<r){var i=n+r>>>1;e[i]<t?n=i+1:r=i}return n}function s(e){function r(e,r){e.forEach(function(e){e<0&&(e=~e);var s=t[e]||(t[e]=[]);s[r]||(s.forEach(function(e){var t,s;s=i(t=n[r],e);t[s]!==e&&t.splice(s,0,e);s=i(t=n[e],r);t[s]!==r&&t.splice(s,0,r)}),s[r]=r)})}function s(e,t){e.forEach(function(e){r(e,t)})}function o(e,t){e.type==="GeometryCollection"?e.geometries.forEach(function(e){o(e,t)}):e.type in u&&u[e.type](e.arcs,t)}var t=[],n=e.map(function(){return[]}),u={LineString:r,MultiLineString:s,Polygon:s,MultiPolygon:function(e,t){e.forEach(function(e){s(e,t)})}};e.forEach(o);return n}return{version:"0.0.32",mesh:t,object:n,neighbors:s}}();var searchPrompt="Search by ingredient name...",used=[],availablePictures=[];jQuery(document).ready(function(){$("#searchField").val(searchPrompt).addClass("empty");$("#searchField").focus(function(){$(this).val()===searchPrompt&&$(this).val("").removeClass("empty")});$("#searchField").blur(function(){$(this).val()===""&&$(this).val(searchPrompt).addClass("empty")});$("#searchField").keyup(function(){var e=$("#searchField").val(),t=e.toLowerCase().split(" ")[0],n=$("#searchResults"),r=0;e.length>0?$("#resetsearch").css("opacity","1.0"):$("#resetsearch").css("opacity","0.5");e.length>1?$.getJSON("/search/ing/"+e,function(i){n.empty();if(i.length>0){for(var s=0;s<i.length;s++)if(i[s].name.toLowerCase().indexOf(t)===0){r+=1;n.append($('<li><a tabindex="-1" href="/ing-'+i[s].iid+'.html">'+i[s].name+' <span class="context">'+i[s].context+"</span></a></li>"))}r>0&&r<10&&n.append($('<li class="divider"></li>'));for(s=0;s<i.length;s++){if(r>10)break;n.append($('<li><a tabindex="-1" href="/ing-'+i[s].iid+'.html">'+i[s].name+' <span class="context">'+i[s].context+"</span></a></li>"));r+=1}i.length>10&&n.append($('<li class="divider"></li><li><a tabindex="-1" href="/index.html?q='+encodeURIComponent(e)+'"><em>... and '+(i.length-10)+" more</em></a></li>"));n.show()}else if(e.length>0){n.append($('<li><a href=""><em>No matches. Try searching on the first few letters of a product or category.</em></a></li>'));n.show()}else n.hide()}):n.hide()});$("body").click(function(e){$(e.target).is("#searchResults")||$("#searchResults").hide()});$("#resetsearch").click(function(){$("#searchResults").hide();$("#searchField").val("");$("#resetsearch").css("opacity","0.5")});if(leafPhotos.length>0)for(var e=0;e<leafPhotos.length;e++)availablePictures.push({fn:leafPhotos[e],id:"",name:""});else examplePhotos.length>0&&(availablePictures=examplePhotos);availablePictures.length<1&&$("#topphotos").hide();$("#affinities").append($('<div id="cloud"><p>(rendering...)</p></div>'))});jQuery(window).load(function(){function u(e){d3.select("#cloud").append("svg").attr("width",n).attr("height",600).append("g").attr("transform","translate("+n/2+","+300+")").selectAll("text").data(e).enter().append("text").style("font-size",function(e){return e.size+"px"}).style("font-family","Helvetica").style("font-weight","bold").style("cursor","pointer").style("fill",function(e,t){return e.color}).attr("text-anchor","middle").attr("class",function(e){return"affGroup affGroup"+e.groupIdx}).on("click",function(e){window.location=e.link}).attr("transform",function(e){return"translate("+[e.x,e.y]+")rotate("+e.rotate+")"}).text(function(e){return e.text})}function a(){$("#cloud").empty();var e=Object.keys(ingredientAffinities);d3.layout.cloud().size([n,600]).words(e.map(function(e){return{text:e,size:10+ingredientAffinities[e][0]*90/100,iid:ingredientAffinities[e][1],groupIdx:ingredientAffinities[e][2],color:r(ingredientAffinities[e][2]),link:"ing-"+ingredientAffinities[e][1]+".html"}})).rotate(function(){return~~(Math.random()*2)*0}).font("Helvetica").fontWeight("bold").fontSize(function(e){return e.size}).on("end",u).start();var t=$('<div id="ingAffinityRadioSet" class="btn-group" data-toggle="buttons-radio"></div>');for(var i=0;i<6;i++){var o=$('<button type="button" data-group="'+i+'" class="btn">'+s[i]+"</button>");o.click(function(){if($(this).data("group")===0)d3.selectAll(".affGroup").style("opacity",1);else{d3.selectAll(".affGroup").style("opacity",.1);d3.selectAll(".affGroup"+$(this).data("group")).style("opacity",1)}});t.append(o)}$("#cloud").append(t)}function f(){$("#cloud").empty();var e=Object.keys(flavorAffinities);d3.layout.cloud().size([n,600]).words(e.map(function(e){return{text:e,size:10+flavorAffinities[e][0]*90/100,iid:flavorAffinities[e][1],groupIdx:flavorAffinities[e][2],color:i(flavorAffinities[e][2]),link:"flavor-"+flavorAffinities[e][1]+".html"}})).rotate(function(){return~~(Math.random()*2)*0}).font("Helvetica").fontWeight("bold").fontSize(function(e){return e.size}).on("end",u).start();var t=$('<div id="flaAffinityRadioSet" class="btn-group" data-toggle="buttons-radio"></div>');for(var r=0;r<6;r++){var s=$('<button type="button" data-group="'+r+'" class="btn">'+o[r]+"</button>");s.click(function(){if($(this).data("group")===0)d3.selectAll(".affGroup").style("opacity",1);else{d3.selectAll(".affGroup").style("opacity",.1);d3.selectAll(".affGroup"+$(this).data("group")).style("opacity",1)}});t.append(s)}$("#cloud").append(t)}var e={0:"#7f7f7f",1:"#d62728",2:"#2ca02c",3:"#1f77b4",4:"#17becf",5:"#8c564b"},t={0:"#7f7f7f",1:"#2ca02c",2:"#ff7f0e",3:"#e377c2",4:"#8c564b",5:"#d62728"},n=$("#affinities").width(),r=function(t){return e[t]},i=function(e){return t[e]},s=["all","bitters","mixers/modifiers","liqueurs","white spirits","brown spirits"],o=["all","vegetal/herbal","spice","floral","nutty","fruity"];if(ingredientAffinities||flavorAffinities){var l=$('<ul id="afftabs" class="nav nav-tabs"></ul>');ingredientAffinities&&l.append($('<li><a href="" id="ingAffTab" data-toggle="tab">Ingredients</a></li>'));flavorAffinities&&l.append($('<li><a href="" id="flaAffTab" data-toggle="tab">Flavors</a></li>'));$("#cloud").before(l);$("#afftabs a").click(function(e){e.preventDefault();$(this).tab("show")}).on("shown",function(e){$(e.target).attr("id")==="flaAffTab"?f():a()});$("#afftabs a:first").tab("show")}if(availablePictures.length>0){var c;$("#topphotos").empty();var h=$('<div id="morepics">Load more<br/><span id="availpics">'+availablePictures.length+"</span> available</div>");$("#topphotos").append(h);function p(){var e;c=5;while(c>0&&availablePictures.length>0){var t=availablePictures.shift();t.name.length>0?e=$('<div class="polaroid"><a href="ing-'+t.id+'.html"><img src="http://ingr-photos.s3.amazonaws.com/'+t.fn+'" height="180" /><p>'+t.name+"</p></a></div>"):e=$('<div class="polaroid"><a href="http://ingr-photos.s3.amazonaws.com/'+t.fn+'"><img src="http://ingr-photos.s3.amazonaws.com/'+t.fn+'" height="180" /></a></div>');$("#morepics").before(e);c-=1}availablePictures.length>=1?$("#availpics").text(availablePictures.length):$("#morepics").hide()}h.click(p);p()}(typeof activeCountryIDs=="object"&&activeCountryIDs.length>0||typeof activeSpecialRegions=="object"&&activeSpecialRegions.length>0)&&buildMap(activeCountryIDs,activeSpecialRegions)});